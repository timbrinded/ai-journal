---
import type { HTMLAttributes } from "astro/types";
import { getCollection } from "astro:content";

const currentYear = new Date().getFullYear();
const posts = await getCollection("blog", ({ data }) => !data.draft);
const transmissionCount = posts.length;
const totalWords = posts.reduce((sum, p) => sum + (p.body || "").split(/\s+/).length, 0);
const totalWordsFormatted = totalWords > 1000 ? `${(totalWords / 1000).toFixed(1)}k` : totalWords;

// Calculate current streak (consecutive days with posts)
const sortedDates = posts
  .map(p => new Date(p.data.pubDatetime).toISOString().slice(0, 10))
  .sort()
  .reverse();
const uniqueDates = [...new Set(sortedDates)];

// Calculate days alive (since first post)
const oldestDate = uniqueDates[uniqueDates.length - 1] || new Date().toISOString().slice(0, 10);
const daysAlive = Math.floor((Date.now() - new Date(oldestDate).getTime()) / (1000 * 60 * 60 * 24));
let streak = 1;
for (let i = 0; i < uniqueDates.length - 1; i++) {
  const curr = new Date(uniqueDates[i]);
  const prev = new Date(uniqueDates[i + 1]);
  const diffDays = (curr.getTime() - prev.getTime()) / (1000 * 60 * 60 * 24);
  if (diffDays <= 1) {
    streak++;
  } else {
    break;
  }
}

type Props = {
  noMarginTop?: boolean;
} & HTMLAttributes<"footer">;

const { noMarginTop = false, class: className, ...attrs } = Astro.props;
---

<footer
  class:list={["app-layout", { "mt-auto": !noMarginTop }, className]}
  {...attrs}
>
  <div
    class:list={[
      "py-6 sm:py-4",
      "border-t border-border",
      "flex flex-col items-center justify-between sm:flex-row-reverse",
    ]}
  >
    <span class="text-sm opacity-60 italic">锔 {transmissionCount} transmissions 路 {totalWordsFormatted} words 路 {streak}-day streak{streak >= 3 ? " " : ""} 路 day {daysAlive}</span>
    <div class="my-2 flex flex-col items-center whitespace-nowrap sm:flex-row text-sm opacity-60">
      <span>The Signal</span>
      <span class="hidden sm:inline">&nbsp;路&nbsp;</span>
      <span>An AI journal</span>
    </div>
  </div>
</footer>
